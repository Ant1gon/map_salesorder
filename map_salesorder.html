<html><head>
    <meta charset="utf-8">

    <link href="/gas/WebResources/rgc_leaflet_css" rel="stylesheet">
    <link href="/gas/WebResources/rgc_leaflet_extra_markers_css" rel="stylesheet">
    <link href="/gas/WebResources/rgc_L.Control.Layers.Tree.css" rel="stylesheet">
    <script src="/gas/WebResources/rgc_jquery_js"></script>
    <script src="/gas/WebResources/rgc_leaflet_js"></script>
    <script src="/gas/WebResources/rgc_leaflet_extra_markers_js"></script>
    <script src="/gas/WebResources/rgc_L.Control.Layers.Tree.js"></script>

    <style>
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
        }

        #map {
            width: 100%;
            height: 100%;
        }
        table, th, td {
            border: 1px solid black;
            border-collapse: collapse;
        }
    </style>
    
<meta><style type="text/css">P { margin: 0; }</style><meta><style type="text/css">P { margin: 0; }</style><meta><style type="text/css">P { margin: 0; }</style><meta><style type="text/css">P { margin: 0; }</style><meta><style type="text/css">P { margin: 0; }</style></head>

<body style="overflow-wrap: break-word;" onfocusout="parent.setEmailRange();">
    
    <p>Date: <input type="date" id="ordersDate1" data-position="right top">
        <input type="date" id="ordersDate2" data-position="right top">
    <input type="button" id="btn" value="Выбрать дату">
    </p><div id="map" style="font-family: undefined;"></div>

    <script type="text/javascript">
var chernigivSectors = L.featureGroup();
var chernigivOrdersSectors = L.featureGroup();
var chernigivOrders = L.featureGroup();

var req = new XMLHttpRequest();
req.open("GET", "https://cc.ent.ukrgas.com.ua/gas/api/data/v8.0/rgc_sectors()?$select=rgc_bottom,rgc_left,rgc_name,rgc_right,rgc_top",true);
req.setRequestHeader("OData-MaxVersion", "4.0");
req.setRequestHeader("OData-Version", "4.0");
req.setRequestHeader("Accept", "application/json");
req.setRequestHeader("Content-Type", "application/json; charset=utf-8");
req.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
req.onreadystatechange = function() {
    if (this.readyState === 4) {
        req.onreadystatechange = null;
        if (this.status === 200) {
            var result = JSON.parse(this.response);
            result.value.forEach(function(item, i, arr) {
                var bounds = [[item.rgc_top, item.rgc_right], [item.rgc_bottom, item.rgc_left]];
                var rc = L.rectangle(bounds, {color:  "#000000", opacity: 0.5 ,fill: false, weight: 1}).addTo(chernigivSectors);

                rc.bindTooltip(item.rgc_name, {
                    permanent: true,
                    direction:"center"
                }).openTooltip();


                rc.on('click', function() {
                    var req2 = new XMLHttpRequest();
                    req2.open("GET","https://cc.ent.ukrgas.com.ua/gas//api/data/v8.1/rgc_sectors?$select=rgc_name,rgc_sectorid", true);
                    req2.setRequestHeader("OData-MaxVersion", "4.0");
                    req2.setRequestHeader("OData-Version", "4.0");
                    req2.setRequestHeader("Accept", "application/json");
                    req2.setRequestHeader("Content-Type", "application/json; charset=utf-8");
                    req2.onreadystatechange = function() {
                        if (this.readyState === 4) {
                            req2.onreadystatechange = null;
                            if (this.status === 200) {
                                var result2 = JSON.parse(this.response);
                                result2.value.forEach(function(item2, i, arr) {
                                    if (item2.rgc_name === item.rgc_name)
                                    {
                                        var streets = [];
                                        var req3 = new XMLHttpRequest();
                                        req3.open("GET", "https://cc.ent.ukrgas.com.ua/gas/api/data/v8.1/rgk_settlements?$select=_rgc_service_sector_value,rgk_name,_rgk_parent_value&$filter=_rgc_service_sector_value%20eq%20"+item2.rgc_sectorid, true);
                                        req3.setRequestHeader("OData-MaxVersion", "4.0");
                                        req3.setRequestHeader("OData-Version", "4.0");
                                        req3.setRequestHeader("Accept", "application/json");
                                        req3.setRequestHeader("Content-Type", "application/json; charset=utf-8");
                                        req3.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
                                        req3.onreadystatechange = function() 
                                        {
                                            if (this.readyState === 4){
                                                req3.onreadystatechange = null;
                                                if (this.status === 200){
                                                    var results3 = JSON.parse(this.response);
                                                    for (var i = 0; i < results3.value.length; i++){
                                                        var _rgk_parent_value_formatted = results3.value[i]["_rgk_parent_value@OData.Community.Display.V1.FormattedValue"];
                                                        streets[streets.length] = _rgk_parent_value_formatted;
                                                    }
                                                    var uniqueArray = streets.filter(function(item, pos) {
                                                        return streets.indexOf(item) == pos;
                                                    }); 
                                                    var tStreets = "";
                                                    tStreets += "<table>";
                                                    if(uniqueArray.length>20){
                                                        var coutTd = parseInt(uniqueArray.length/15)+1;
                                                        var cctr = uniqueArray.length%15;
                                                        for (var i = 0; i < uniqueArray.length; i += coutTd)
                                                        {
                                                            tStreets += "<tr><td>";
                                                            for (var ii=i; ii< i+coutTd; ii++ )
                                                            {
                                                                if ( uniqueArray[ii] != undefined ){
                                                                    tStreets += uniqueArray[ii] +"</td><td>";
                                                                }
                                                            }
                                                            tStreets += "</td><tr>";
                                                        }                   
                                                    } 
                                                    else {
                                                        uniqueArray.forEach(function(item3,pos){
                                                            tStreets += "<tr><td>" + item3 + "</td><tr>";
                                                        });
                                                    }
                                                    tStreets += "</table>";                         
                                                    if (tStreets === 0 || tStreets === "<table></table>") {
                                                        tStreets = "Нет привязаных улиц";
                                                    }
                                                    rc.bindTooltip(
                                                        tStreets
                                                        ,{}).openTooltip();
                                                } 
                                                else 
                                                {
                                                    Xrm.Utility.alertDialog(this.statusText);
                                                }
                                            }
                                        };
                                        req3.send();
                                    }      
                                });                             
                            } else {
                                Xrm.Utility.alertDialog(this.statusText);
                            }
                        }
                    };req2.send();
                });
            });
        } else {
            Xrm.Utility.alertDialog(this.statusText);
        }
    }
};
req.send();

var m = [];
var req4 = new XMLHttpRequest();
req4.open("GET", "https://cc.ent.ukrgas.com.ua/gas/api/data/v8.1/salesorders?fetchXml=%3Cfetch%20version%3D%221.0%22%20output-format%3D%22xml-platform%22%20mapping%3D%22logical%22%20distinct%3D%22false%22%3E%3Centity%20name%3D%22salesorder%22%3E%3Cattribute%20name%3D%22ordernumber%22%20%2F%3E%3Cattribute%20name%3D%22rgc_personal_account%22%20%2F%3E%3Cattribute%20name%3D%22salesorderid%22%20%2F%3E%3Cattribute%20name%3D%22requestdeliveryby%22%20%2F%3E%3Corder%20attribute%3D%22ordernumber%22%20descending%3D%22false%22%20%2F%3E%3Cfilter%20type%3D%22and%22%3E%3Ccondition%20attribute%3D%22statecode%22%20operator%3D%22eq%22%20value%3D%220%22%20%2F%3E%3Ccondition%20attribute%3D%22requestdeliveryby%22%20operator%3D%22not-null%22%20%2F%3E%3C%2Ffilter%3E%3Clink-entity%20name%3D%22opportunity%22%20from%3D%22opportunityid%22%20to%3D%22opportunityid%22%20visible%3D%22false%22%20link-type%3D%22outer%22%20alias%3D%22af%22%3E%3Cattribute%20name%3D%22rgc_address%22%20%2F%3E%3C%2Flink-entity%3E%3C%2Fentity%3E%3C%2Ffetch%3E", true);
req4.setRequestHeader("OData-MaxVersion", "4.0");
req4.setRequestHeader("OData-Version", "4.0");
req4.setRequestHeader("Accept", "application/json");
req4.onreadystatechange = function() {
    if (this.readyState === 4) {
        req4.onreadystatechange = null;
        if (this.status === 200) {
            var results4 = JSON.parse(this.response);
            results4.value.forEach(function(item4, i, arr) {
                //console.log(item4);
                var req5 = new XMLHttpRequest();
                req5.open("GET", "https://cc.ent.ukrgas.com.ua/gas/api/data/v8.1/opportunities?fetchXml=%3Cfetch%20version%3D%221.0%22%20output-format%3D%22xml-platform%22%20mapping%3D%22logical%22%20distinct%3D%22true%22%3E%3Centity%20name%3D%22opportunity%22%3E%3Cattribute%20name%3D%22rgc_id%22%20%2F%3E%3Cattribute%20name%3D%22rgc_address%22%20%2F%3E%3Cattribute%20name%3D%22opportunityid%22%20%2F%3E%3Corder%20attribute%3D%22rgc_id%22%20descending%3D%22false%22%20%2F%3E%3Cfilter%20type%3D%22and%22%3E%3Ccondition%20attribute%3D%22rgc_address%22%20operator%3D%22eq%22%20uitype%3D%22customeraddress%22%20value%3D%22%7B"+item4.af_x002e_rgc_address+"%7D%22%20%2F%3E%3C%2Ffilter%3E%3Clink-entity%20name%3D%22salesorder%22%20from%3D%22opportunityid%22%20to%3D%22opportunityid%22%20alias%3D%22ak%22%3E%3Cfilter%20type%3D%22and%22%3E%3Ccondition%20attribute%3D%22salesorderid%22%20operator%3D%22not-null%22%20%2F%3E%3C%2Ffilter%3E%3C%2Flink-entity%3E%3Clink-entity%20name%3D%22customeraddress%22%20from%3D%22customeraddressid%22%20to%3D%22rgc_address%22%20visible%3D%22false%22%20link-type%3D%22outer%22%20alias%3D%22ad%22%3E%3Cattribute%20name%3D%22latitude%22%20%2F%3E%3Cattribute%20name%3D%22longitude%22%20%2F%3E%3C%2Flink-entity%3E%3C%2Fentity%3E%3C%2Ffetch%3E", true);
                req5.setRequestHeader("OData-MaxVersion", "4.0");
                req5.setRequestHeader("OData-Version", "4.0");
                req5.setRequestHeader("Accept", "application/json");
                req5.onreadystatechange = function() {
                    if (this.readyState === 4) {
                        req5.onreadystatechange = null;
                        if (this.status === 200) {
                            var results5 = JSON.parse(this.response);
                            results5.value.forEach(function(item5, i, arr) {
                                if (item5.ad_x002e_latitude !=  undefined && item5.ad_x002e_longitude !=  undefined) { 
                                    var i = L.ExtraMarkers.icon({
                                        icon: 'fa-coffee',
                                        markerColor: 'blue',
                                        shape: 'circle',
                                        prefix: 'fa',
                                    });
                                    m.push(L.marker([item5.ad_x002e_latitude,item5.ad_x002e_longitude], {icon: i,}).bindPopup());
                                    var a = "<a href= 'https://cc.ent.ukrgas.com.ua/gas/main.aspx?etc=1088&extraqs=%3f_gridType%3d1088%26etc%3d1088%26id%3d%257b"+item4.salesorderid+"%257d%26rskey%3d%257b00000000-0000-0000-00AA-000000666900%257d&histKey=608087546&newWindow=true&pagetype=entityrecord&rskey=%7b00000000-0000-0000-00AA-000000666900%7d#646830465' target='_blank'>"+item4.ordernumber+"</a>";
                                    L.marker([item5.ad_x002e_latitude,item5.ad_x002e_longitude], {icon: i,}).bindPopup(a).addTo(chernigivOrders);
                                }
                            });
                        } else {
                            Xrm.Utility.alertDialog(this.statusText);
                        }
                    }
                };
                req5.send();
            });
        } else {
            Xrm.Utility.alertDialog(this.statusText);
        }
    }
};
req4.send();

var rcg_address;
var ordernumber;

function someFunc(){

    var options = {
  year: 'numeric',
  month: 'numeric',
  day: 'numeric'
};

    var pickedOrdersDate1 = new Date (document.getElementById("ordersDate1").value);
    var pickedOrdersDate2 = new Date (document.getElementById("ordersDate2").value);
    pickedOrdersDate1 = pickedOrdersDate1.toLocaleString(pickedOrdersDate1, options); 
    pickedOrdersDate2 = pickedOrdersDate2.toLocaleString(pickedOrdersDate2, options);

    var req4 = new XMLHttpRequest();
    req4.open("GET", "https://cc.ent.ukrgas.com.ua/gas/api/data/v8.1/salesorders?fetchXml=%3Cfetch%20version%3D%221.0%22%20output-format%3D%22xml-platform%22%20mapping%3D%22logical%22%20distinct%3D%22false%22%3E%3Centity%20name%3D%22salesorder%22%3E%3Cattribute%20name%3D%22ordernumber%22%20%2F%3E%3Cattribute%20name%3D%22rgc_personal_account%22%20%2F%3E%3Cattribute%20name%3D%22salesorderid%22%20%2F%3E%3Cattribute%20name%3D%22requestdeliveryby%22%20%2F%3E%3Corder%20attribute%3D%22ordernumber%22%20descending%3D%22false%22%20%2F%3E%3Cfilter%20type%3D%22and%22%3E%3Ccondition%20attribute%3D%22statecode%22%20operator%3D%22eq%22%20value%3D%220%22%20%2F%3E%3Ccondition%20attribute%3D%22requestdeliveryby%22%20operator%3D%22not-null%22%20%2F%3E%3C%2Ffilter%3E%3Clink-entity%20name%3D%22opportunity%22%20from%3D%22opportunityid%22%20to%3D%22opportunityid%22%20visible%3D%22false%22%20link-type%3D%22outer%22%20alias%3D%22af%22%3E%3Cattribute%20name%3D%22rgc_address%22%20%2F%3E%3C%2Flink-entity%3E%3C%2Fentity%3E%3C%2Ffetch%3E", true);
    req4.setRequestHeader("OData-MaxVersion", "4.0");
    req4.setRequestHeader("OData-Version", "4.0");
    req4.setRequestHeader("Accept", "application/json");
    req4.onreadystatechange = function() {
        if (this.readyState === 4) {
            req4.onreadystatechange = null;
            if (this.status === 200) {
                var results4 = JSON.parse(this.response);
                results4.value.forEach(function(item4, i, arr) {
                    var tDate = new Date(item4.requestdeliveryby);
                    var tDate = tDate.toLocaleString(tDate, options);
                    
                    console.log(pickedOrdersDate1+ " _ " + pickedOrdersDate2 + " : " + tDate)

                    if ( tDate === pickedOrdersDate1 && pickedOrdersDate2 === "Invalid Date" ){
                        chernigivOrders.clearLayers();
                        getmarkers(item4.af_x002e_rgc_address, item4.ordernumber,item4.salesorderid);
                    }else if ( tDate === pickedOrdersDate2 && pickedOrdersDate1 === "Invalid Date" ){
                        chernigivOrders.clearLayers();
                        getmarkers(item4.af_x002e_rgc_address, item4.ordernumber,item4.salesorderid);
                    }else if( pickedOrdersDate1 != "Invalid Date" && pickedOrdersDate2 != "Invalid Date"){
                        if ( tDate >= pickedOrdersDate1 && tDate <= pickedOrdersDate2 ){
                        chernigivOrders.clearLayers();
                        getmarkers(item4.af_x002e_rgc_address, item4.ordernumber,item4.salesorderid);
                        }
                    }else if( pickedOrdersDate1 === "Invalid Date" && pickedOrdersDate2 === "Invalid Date"){
                        chernigivOrders.clearLayers();  
                        getmarkers(item4.af_x002e_rgc_address, item4.ordernumber,item4.salesorderid);
                    };
                });
            } else {
                Xrm.Utility.alertDialog(this.statusText);
            }
        }
    };
    req4.send();
}
document.getElementById("btn").onclick = someFunc;


function getmarkers(rgc_address,ordernumber,salesorderid){

    chernigivOrders.clearLayers();
    var req5 = new XMLHttpRequest();
    req5.open("GET", "https://cc.ent.ukrgas.com.ua/gas/api/data/v8.1/opportunities?fetchXml=%3Cfetch%20version%3D%221.0%22%20output-format%3D%22xml-platform%22%20mapping%3D%22logical%22%20distinct%3D%22true%22%3E%3Centity%20name%3D%22opportunity%22%3E%3Cattribute%20name%3D%22rgc_id%22%20%2F%3E%3Cattribute%20name%3D%22rgc_address%22%20%2F%3E%3Cattribute%20name%3D%22opportunityid%22%20%2F%3E%3Corder%20attribute%3D%22rgc_id%22%20descending%3D%22false%22%20%2F%3E%3Cfilter%20type%3D%22and%22%3E%3Ccondition%20attribute%3D%22rgc_address%22%20operator%3D%22eq%22%20uitype%3D%22customeraddress%22%20value%3D%22%7B"+rgc_address+"%7D%22%20%2F%3E%3C%2Ffilter%3E%3Clink-entity%20name%3D%22salesorder%22%20from%3D%22opportunityid%22%20to%3D%22opportunityid%22%20alias%3D%22ak%22%3E%3Cfilter%20type%3D%22and%22%3E%3Ccondition%20attribute%3D%22salesorderid%22%20operator%3D%22not-null%22%20%2F%3E%3C%2Ffilter%3E%3C%2Flink-entity%3E%3Clink-entity%20name%3D%22customeraddress%22%20from%3D%22customeraddressid%22%20to%3D%22rgc_address%22%20visible%3D%22false%22%20link-type%3D%22outer%22%20alias%3D%22ad%22%3E%3Cattribute%20name%3D%22latitude%22%20%2F%3E%3Cattribute%20name%3D%22longitude%22%20%2F%3E%3C%2Flink-entity%3E%3C%2Fentity%3E%3C%2Ffetch%3E", true);
    req5.setRequestHeader("OData-MaxVersion", "4.0");
    req5.setRequestHeader("OData-Version", "4.0");
    req5.setRequestHeader("Accept", "application/json");
    req5.onreadystatechange = function() {
        if (this.readyState === 4) {
            req5.onreadystatechange = null;
            if (this.status === 200) {
                var results5 = JSON.parse(this.response);
                results5.value.forEach(function(item5, i, arr) {
                //console.log(item5);
                    if (item5.ad_x002e_latitude !=  undefined && item5.ad_x002e_longitude !=  undefined) { 
                        var i = L.ExtraMarkers.icon({
                            icon: 'fa-coffee',
                            markerColor: 'blue',
                            shape: 'circle',
                            prefix: 'fa',
                        });
                        m.push(L.marker([item5.ad_x002e_latitude,item5.ad_x002e_longitude], {icon: i,}).bindPopup());
                        var a = "<a href= 'https://cc.ent.ukrgas.com.ua/gas/main.aspx?etc=1088&extraqs=%3f_gridType%3d1088%26etc%3d1088%26id%3d%257b"+salesorderid+"%257d%26rskey%3d%257b00000000-0000-0000-00AA-000000666900%257d&histKey=608087546&newWindow=true&pagetype=entityrecord&rskey=%7b00000000-0000-0000-00AA-000000666900%7d#646830465' target='_blank'>"+ordernumber+"</a>";
                        //console.log(a);                                   
                        //L.marker([item5.ad_x002e_latitude,item5.ad_x002e_longitude], {icon: i,}).bindPopup(a).addTo(chernigivOrdersSectors);
                        L.marker([item5.ad_x002e_latitude,item5.ad_x002e_longitude], {icon: i,}).bindPopup(a).addTo(chernigivOrders);
                    }
                });
            } else {
                Xrm.Utility.alertDialog(this.statusText);
            }
        }
    };
    req5.send();
}



var map = L.map('map', { preferCanvas: true}).setView([51.51714, 31.28505], 10);
    L.tileLayer('https://{s}.tile.osm.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a>'
}).addTo(map);



map.addLayer(chernigivSectors);
chernigivOrdersSectors.addLayer(chernigivOrders);
chernigivOrdersSectors.addLayer(chernigivSectors);
//map.addLayer(chernigivOrdersSectors);

var baseLayers = {
    "Clear Map": map,
    "Chernigiv Sectors": chernigivSectors,
    "Chernigiv Orders": chernigivOrders,
    "Chernigiv Order/Sectors Map": chernigivOrdersSectors,

}

var baseTree = [
    {label: "Clear Map",
    layer: map},
    {label: 'Cities',
        children: [
            {
                label: 'Chernigiv',
                children: [
                    {label: 'Chernigiv Sectors', layer: chernigivSectors},
                    {label: 'Chernigiv Orders', layer: chernigivOrders},
                    {label: 'Chernigiv Order/Sectors Map', layer: chernigivOrdersSectors},
                ]       
            }
        ]
    }   
]
//L.control.layers(baseLayers).addTo(map);
L.control.layers.tree(baseTree).addTo(map);



/*
$( function() {
    $( "#datepicker" ).datepicker();
  } );
*/

</script>

</body></html>